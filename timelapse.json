[{"id":"9c439745.ecd388","type":"subflow","name":"Make AVI File","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"518d5f7e.fc5308"}]}],"out":[{"x":1340,"y":200,"wires":[{"id":"d5215bbc.ba773","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"868b235e.6c7e98","type":"function","z":"9c439745.ecd388","name":"Indexfile","func":"msg.filename = msg.path + msg.timelapse.filename + '/avi.index';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":200,"wires":[["bbfebd42.0e2b3"]]},{"id":"bbfebd42.0e2b3","type":"file in","z":"9c439745.ecd388","name":"Index file","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":380,"y":200,"wires":[["dfcd8768.17c3b8"]]},{"id":"dfcd8768.17c3b8","type":"function","z":"9c439745.ecd388","name":"Generate indexbuffer","func":"function toLILEND( value, buf, dword) {\n    pos = dword * 4;\n    buf[pos + 0] = (value & 0xff);\n    buf[pos + 1] = ( (value >> 8 ) & 0xff);\n    buf[pos + 2] = ( (value >> 16 ) & 0xff);\n    buf[pos + 3] = ( (value >> 24 ) & 0xff);\n}\n\nfunction toFOURCC(text, buf, dword) {\n    pos = dword * 4;\n    buf[pos + 0] = text.charCodeAt(0);\n    buf[pos + 1] = text.charCodeAt(1);\n    buf[pos + 2] = text.charCodeAt(2);\n    buf[pos + 3] = text.charCodeAt(3);\n}\n\nvar index = [];\nvar offset = 4;\nrows = msg.payload.split(\"\\n\");\nrows.forEach(function(line){\n    if(line.length < 2)\n        return;\n    size = parseInt(line);\n    index.push({\n        offset: offset,\n        size: size\n    });\n    offset += size + 8;\n});\n\nbuffer = Buffer.alloc( 8 + index.length * 16);\n\ntoFOURCC(\"idx1\",buffer,0);\ntoLILEND(index.length*16, buffer,1);  //Index size\n\nfor( var i = 0; i < index.length; i++) {\n    var dword = 2 + (i*4);\n    toFOURCC(\"00db\", buffer, dword);\n    toLILEND(index[i].offset, buffer, dword+1);\n    toLILEND(0, buffer, dword+2);  //FLAGS\n    toLILEND(index[i].size, buffer,dword+3);\n}\n\nmsg.payload = buffer;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":200,"wires":[["7a267107.f1c238"]],"info":"00  DWORD LIST_RIFF;        // \"RIFF\"\n01  DWORD RIFF_size;        // \n02  DWORD RIFF_FOURCC;      // \"avi \"\n03  DWORD LIST_HDRL;         // \"LIST\"\n04  DWORD hdrl_size;         // 208\n05  DWORD hdrl_name;         // \"hdrl\"\n06  DWORD avih;              // \"avih\"\n07 DWORD avih_size;         // 56\n08  DWORD AVIH_MicroSecPerFrame;\n09  DWORD AVIH_MaxBytesPerSec;\n10  DWORD AVIH_PaddingGranularity;\n11  DWORD AVIH_Flags;\n12  DWORD AVIH_TotalFrames;\n13  DWORD AVIH_InitialFrames;\n14  DWORD AVIH_Streams;\n15  DWORD AVIH_SugestedBufferSize;\n16  DWORD AVIH_Width;\n17  DWORD AVIH_Height;\n18  DWORD AVIH_Reserved1;\n19  DWORD AVIH_Reserved2;\n20  DWORD AVIH_Reserved3;\n21  DWORD AVIH_Reserved4;\n22  DWORD LIST_strl;          // \"LIST\"\n23  DWORD LIST_strl_size;     // 132\n24  DWORD LIST_strl_name;     // \"strl\"\n25  DWORD STRH_name;          // \"strh\"\n26  DWORD STRH_size;          // 48\n27  DWORD strh_fccType;\n28  DWORD strh_fccHandler;\n29  DWORD strh_flags;\n30  DWORD strh_priority;\n31  DWORD strh_init_frames;\n32  DWORD strh_scale;\n33  DWORD strh_rate;\n34  DWORD strh_start;\n45  DWORD strh_length;\n36  DWORD strh_sugg_buff_sz;\n37  DWORD strh_quality;\n38  DWORD strh_sample_sz;\n39  DWORD LIST_strf;          // \"strf\"\n40  DWORD strf_size_list;     // 40\n41  DWORD strf_size;          // 40\n42  DWORD strf_width;\n43  DWORD strf_height;\n44  DWORD strf_planes_bit_cnt;\n45  DWORD strf_compression;\n46  DWORD strf_image_size;\n47  DWORD strf_xpels_meter;\n48  DWORD strf_ypels_meter;\n49  DWORD strf_num_colors;\n50  DWORD strf_imp_colors;\n51  DWORD LIST_ODML;          // \"LIST\"\n52  DWORD LIST_ODML_Size;     // 16\n53  DWORD LIST_ODML_type;     // \"odml\"\n54  DWORD odml_fourCC;        // \"dmlh\"\n55  DWORD odml_size;          // 4\n56  DWORD odml_frames;  \n57  DWORD LIST_movi;          // \"LIST\"\n58  DWORD LIST_movi_size;     // SUM( JPEG data size) + (8 * frames) + 4\n59  DWORD LIST_movi_name;     // \"movi\"\n"},{"id":"518d5f7e.fc5308","type":"function","z":"9c439745.ecd388","name":"Headerfile","func":"msg.filename = msg.path + msg.timelapse.filename + '/avi.header';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":80,"wires":[["bd0b3a4.72e7a48"]]},{"id":"bd0b3a4.72e7a48","type":"file in","z":"9c439745.ecd388","name":"Header File","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":390,"y":80,"wires":[["f9ec1d77.bebd3"]]},{"id":"f9ec1d77.bebd3","type":"function","z":"9c439745.ecd388","name":"Update AVI header","func":"\nfunction toLILEND( value, buf, dword) {\n    pos = dword * 4;\n    buf[pos + 0] = (value & 0xff);\n    buf[pos + 1] = ( (value >> 8 ) & 0xff);\n    buf[pos + 2] = ( (value >> 16 ) & 0xff);\n    buf[pos + 3] = ( (value >> 24 ) & 0xff);\n}\n\nnode.warn(msg.download);\n\nbuffer = msg.payload;\n\nvar fps = msg.timelapse.fps;\nif(msg.download.fps !== null ) {\n    fps = msg.download.fps;\n    toLILEND( parseInt(1000000/msg.download.fps), buffer, 8 ); //AVIH_MicroSecPerFrame;\n    toLILEND( parseInt(msg.download.fps), buffer, 33 ); //strh_rate\n}\n\nvar RIFF_Size = msg.timelapse.size + (msg.timelapse.frames* 24);\n\ntoLILEND( RIFF_Size, buffer, 1 ); //RIFF_size.  24 = jpeg-entry(8) + index-entry(16)\ntoLILEND( parseInt((RIFF_Size/msg.timelapse.frames) / fps), buffer, 9 ); //AVIH_MaxBytesPerSec\ntoLILEND( msg.timelapse.frames, buffer, 12 ); //AVIH_TotalFrames\ntoLILEND( msg.timelapse.frames, buffer, 35 ); //strh_length\ntoLILEND( parseInt(RIFF_Size/fps), buffer, 36 ); //strh_sugg_buff_sz\ntoLILEND( msg.timelapse.frames, buffer, 56 ); //odml_frames\ntoLILEND( msg.timelapse.size + ( 8 * msg.timelapse.frames) + 4, buffer, 58 ); //LIST_movi_size = JPEG data size + (8 * frames) + 4\n\nmsg.payload = buffer;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":80,"wires":[["963eaf00.8ce41"]]},{"id":"71edd57d.30875c","type":"function","z":"9c439745.ecd388","name":"Datafile","func":"msg.filename = msg.path + msg.timelapse.filename + '/avi.data';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":140,"wires":[["8fefb497.08f598"]]},{"id":"8fefb497.08f598","type":"file in","z":"9c439745.ecd388","name":"Data File","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":380,"y":140,"wires":[["b938c43f.3309e"]]},{"id":"963eaf00.8ce41","type":"function","z":"9c439745.ecd388","name":"AVI File","func":"msg.filename = msg.path + msg.timelapse.filename + '/avi.avi';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":80,"wires":[["c9902e3b.c93bd8"]]},{"id":"c9902e3b.c93bd8","type":"file","z":"9c439745.ecd388","name":"avi.avi","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":990,"y":80,"wires":[["71edd57d.30875c"]]},{"id":"ead0fbcb.057248","type":"file","z":"9c439745.ecd388","name":"avi.avi","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":810,"y":140,"wires":[["868b235e.6c7e98"]]},{"id":"b938c43f.3309e","type":"function","z":"9c439745.ecd388","name":"AVI File","func":"msg.filename = msg.path + msg.timelapse.filename + '/avi.avi';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":140,"wires":[["ead0fbcb.057248"]]},{"id":"7a267107.f1c238","type":"function","z":"9c439745.ecd388","name":"AVI File","func":"msg.filename = msg.path + msg.timelapse.filename + '/avi.avi';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":200,"wires":[["9db3e688.2c8f38"]]},{"id":"9db3e688.2c8f38","type":"file","z":"9c439745.ecd388","name":"avi.avi","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":990,"y":200,"wires":[["d5215bbc.ba773"]]},{"id":"d5215bbc.ba773","type":"change","z":"9c439745.ecd388","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"filename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1170,"y":200,"wires":[[]]},{"id":"806f967.bc952e8","type":"tab","label":"Timelapse Backend","disabled":false,"info":""},{"id":"6a59659e.dba2a4","type":"group","z":"806f967.bc952e8","name":"GET /timelapse","style":{"fill":"#e3f3d3","label":true},"nodes":["9912d838.5765a8","affa29f6.c49e98","68457c90.cba174","95b8fea6.1992f8","b78b0155.d3683"],"x":114,"y":79,"w":882,"h":82},{"id":"80a9e208.50ded8","type":"group","z":"806f967.bc952e8","name":"GET /timelapse/export?name=name&fps=10","style":{"fill":"#e3f3d3","label":true},"nodes":["b34a20ab.e80cb8","555a19d4.9f385","d44334f2.b4e63","14f645dd.f3eba2","5a339d1c.be877c","bb50ffab.f211a","f056eabe.8c4e38"],"x":114,"y":559,"w":1182,"h":122},{"id":"874fd402.b76fa","type":"group","z":"806f967.bc952e8","name":"GET /timelapse/capture&name=name","style":{"fill":"#e3f3d3","label":true},"nodes":["f1070de9.9b84d","a21a5950.c32b28","9d934ce6.edf168","9386e2f7.397038","b1016c5b.cb1108","9f6afe2d.dae7e8","db060408.3c1af","70cdda8d.424ae4","7e3a6694.9a7508","24998381.eba1fc","6c9aa8ce.ff4ef","b963606f.aeb918","48c971e4.4f695"],"x":114,"y":719,"w":1452,"h":182},{"id":"8ea22993.f0a7b","type":"group","z":"806f967.bc952e8","name":"DELETE /timelapse {\"name\":\"Some Name\"}","style":{"fill":"#e3f3d3","label":true},"nodes":["64eb4c38.9c8304","6c8a1b4f.eebf94","69279898.bde68","4f121ab8.254cf4","67745d8d.2cf4a4","f3501c9c.af39","40afe6bc.baf638","15e6cd00.29090b"],"x":114,"y":371.5,"w":1152,"h":149.5},{"id":"a19564b8.e45188","type":"group","z":"806f967.bc952e8","name":"Healpers","style":{"fill":"#ffffbf","label":true},"nodes":["c8422c48.446638","d50331c7.ca1db","3e7e69c8.232186","f03c26ff.1a825","22fb67ac.2e5be8"],"x":1474,"y":39,"w":512,"h":142},{"id":"ab8145ac.86fb5","type":"group","z":"806f967.bc952e8","name":"POST /timelapse/capture {name=name,address:address,user:user,password,passowrd}","style":{"fill":"#e3f3d3","label":true},"nodes":["db91f259.4d692","15f226ff.ba5691","8543fb83.e062d","f1323354.b2dd88","2e3a19a1.09c306","83ee01eb.a17318","88872a61.454258","fe11c45d.a72058","45972405.864dcc","9364d2f5.d053f8","4f7fbaa7.0e6644","4300f927.0f1d48","207ae537.fba842"],"x":114,"y":939,"w":1452,"h":182},{"id":"bb3e510e.943d1","type":"group","z":"806f967.bc952e8","name":"API Test ","style":{"fill":"#bfdbef","label":true},"nodes":["7ca7259c.c40d5c","3ce24065.52258","7132482f.f197d","535a2b7f.8b3acc","a1a0ba07.85b37","8ca725b4.8ee908","718b8c5b.76da84","982fed3e.3169f","ff439a50.7b20d","78d97784.494ea","9e44dcc7.a90128","e1c07ef1.7d71f"],"x":1834,"y":199,"w":732,"h":222},{"id":"e4467bc4.acab98","type":"group","z":"806f967.bc952e8","name":"POST /timelpase {name:\"name\",width:640,height:480,fps:15}}","style":{"label":true,"fill":"#e3f3d3"},"nodes":["831c5aaa.edff6","c3e70bf1.45dcd","630eb70f.8fc01","1d4e8c50.a8e83c","ec42ed35.143768","ea25973f.c518b8","587e9b12.06992c","c7f44295.35241"],"x":114,"y":199,"w":1212,"h":142},{"id":"9912d838.5765a8","type":"http in","z":"806f967.bc952e8","g":"6a59659e.dba2a4","name":"","url":"/timelapse","method":"get","upload":false,"swaggerDoc":"","x":220,"y":120,"wires":[["affa29f6.c49e98"]]},{"id":"7e3a6694.9a7508","type":"http response","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","statusCode":"400","headers":{},"x":620,"y":820,"wires":[]},{"id":"c8422c48.446638","type":"catch","z":"806f967.bc952e8","g":"a19564b8.e45188","name":"File error","scope":["a4871533.2fe108","a21a5950.c32b28","9386e2f7.397038"],"uncaught":false,"x":1560,"y":140,"wires":[["d50331c7.ca1db"]]},{"id":"d50331c7.ca1db","type":"function","z":"806f967.bc952e8","g":"a19564b8.e45188","name":"message","func":"msg.payload = {\n    message: \"Internal file error\"\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1740,"y":140,"wires":[["3e7e69c8.232186"]]},{"id":"3e7e69c8.232186","type":"http response","z":"806f967.bc952e8","g":"a19564b8.e45188","name":"","statusCode":"500","headers":{},"x":1900,"y":140,"wires":[]},{"id":"718b8c5b.76da84","type":"inject","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"Create Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"name\":\"Test\",\"width\":320,\"height\":180,\"fps\":15}","payloadType":"json","x":1950,"y":280,"wires":[["982fed3e.3169f"]]},{"id":"1971ab22.eb74d5","type":"inject","z":"806f967.bc952e8","name":"Set sroarage location Camera","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":310,"y":40,"wires":[["a5717423.5da4b"]]},{"id":"a5717423.5da4b","type":"change","z":"806f967.bc952e8","name":"/var/spool/storage/SD_DISK/timelapse/","rules":[{"t":"set","p":"storage","pt":"flow","to":"/var/spool/storage/SD_DISK/timelapse/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":40,"wires":[[]]},{"id":"982fed3e.3169f","type":"http request","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"POST /timelapse","method":"POST","ret":"obj","paytoqs":"ignore","url":"localhost:1880/timelapse","tls":"","persist":false,"proxy":"","authType":"basic","x":2190,"y":280,"wires":[["ff439a50.7b20d"]]},{"id":"ff439a50.7b20d","type":"debug","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2430,"y":280,"wires":[]},{"id":"f1070de9.9b84d","type":"axis-camera","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","preset":"9ffd68a3.cf5118","action":"JPEG Image","resolution":"320x180","output":"Buffer","filename":"","options":"","x":630,"y":760,"wires":[["9f6afe2d.dae7e8"]]},{"id":"a21a5950.c32b28","type":"file","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":1130,"y":760,"wires":[["9d934ce6.edf168"]]},{"id":"9d934ce6.edf168","type":"function","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"Indexfile","func":"msg.filename = flow.get(\"storage\") + msg.timelapse.filename + '/avi.index';\n\nd = new Date();\n\nmsg.timelapse.frames++;\nmsg.timelapse.size += msg.payload.length;\nif( msg.timelapse.first === null )\n    msg.timelapse.first = d.getTime();\nmsg.timelapse.last = d.getTime();\n\nmsg.payload = msg.size;\n\ntimelapse = flow.get(\"timelapse\") || {};\ntimelapse[msg.timelapse.name] = msg.timelapse;\nflow.set(\"timelapse\",timelapse);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":800,"wires":[["9386e2f7.397038"]]},{"id":"9386e2f7.397038","type":"file","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":1130,"y":800,"wires":[["48c971e4.4f695"]]},{"id":"b1016c5b.cb1108","type":"function","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"Datafile","func":"msg.filename = flow.get(\"storage\") + msg.timelapse.filename + '/avi.data';\n\njpeg = msg.payload;\navi1String = \"AVI1\";\njpeg[6] = avi1String.charCodeAt(0);\njpeg[7] = avi1String.charCodeAt(1);\njpeg[8] = avi1String.charCodeAt(2);\njpeg[9] = avi1String.charCodeAt(3);\n\nsize = jpeg.length;\npadding = (4-(size%4)) % 4;\nsize += padding;\nentry = Buffer.alloc(8);\n//entry = '00db' + JPEG_Size\n\nvar entryString = \"00db\";\nentry[0] = entryString.charCodeAt(0);\nentry[1] = entryString.charCodeAt(1);\nentry[2] = entryString.charCodeAt(2);\nentry[3] = entryString.charCodeAt(3);\nentry[4] = size & 0xff;\nentry[5] = (size >> 8) & 0xff;\nentry[6] = (size >> 16) & 0xff;\nentry[7] = (size >> 24) & 0xff;\npaddingBuffer = Buffer.alloc(padding);\n\ntotalLength = entry.length + jpeg.length + paddingBuffer.length;\nmsg.payload = Buffer.concat([entry,jpeg,paddingBuffer], totalLength);\n\nmsg.size = size;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":760,"wires":[["a21a5950.c32b28"]]},{"id":"9f6afe2d.dae7e8","type":"switch","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"OK?","property":"error","propertyType":"msg","rules":[{"t":"eq","v":"false","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":760,"wires":[["b1016c5b.cb1108"],["24998381.eba1fc"]]},{"id":"db060408.3c1af","type":"http in","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","url":"/timelapse/capture","method":"get","upload":false,"swaggerDoc":"","x":240,"y":760,"wires":[["70cdda8d.424ae4"]]},{"id":"70cdda8d.424ae4","type":"function","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"Validate request","func":"if( !msg.payload.hasOwnProperty(\"name\") ) {\n    msg.payload = {\n        error: \"Missing name\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\ntimelapse = flow.get(\"timelapse\") || {};\nif( !timelapse.hasOwnProperty(msg.payload.name) ) {\n    msg.payload = {\n        error: \"Timelapse \" + msg.payload.name + \" is invalid\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nmsg.payload = timelapse[msg.payload.name];\nmsg.timelapse = msg.payload;\nmsg.resolution = msg.payload.width + \"x\" + msg.payload.height;\n\nnode.send([msg,null]);\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":760,"wires":[["f1070de9.9b84d"],["7e3a6694.9a7508"]],"info":"00  DWORD LIST_RIFF;        // \"RIFF\"\n01  DWORD RIFF_size;        // \n02  DWORD RIFF_FOURCC;      // \"avi \"\n03  DWORD LIST_HDRL;         // \"LIST\"\n04  DWORD hdrl_size;         // 208\n05  DWORD hdrl_name;         // \"hdrl\"\n06  DWORD avih;              // \"avih\"\n07 DWORD avih_size;         // 56\n08  DWORD AVIH_MicroSecPerFrame;\n09  DWORD AVIH_MaxBytesPerSec;\n10  DWORD AVIH_PaddingGranularity;\n11  DWORD AVIH_Flags;\n12  DWORD AVIH_TotalFrames;\n13  DWORD AVIH_InitialFrames;\n14  DWORD AVIH_Streams;\n15  DWORD AVIH_SugestedBufferSize;\n16  DWORD AVIH_Width;\n17  DWORD AVIH_Height;\n18  DWORD AVIH_Reserved1;\n19  DWORD AVIH_Reserved2;\n20  DWORD AVIH_Reserved3;\n21  DWORD AVIH_Reserved4;\n22  DWORD LIST_strl;          // \"LIST\"\n23  DWORD LIST_strl_size;     // 132\n24  DWORD LIST_strl_name;     // \"strl\"\n25  DWORD STRH_name;          // \"strh\"\n26  DWORD STRH_size;          // 48\n27  DWORD strh_fccType;\n28  DWORD strh_fccHandler;\n29  DWORD strh_flags;\n30  DWORD strh_priority;\n31  DWORD strh_init_frames;\n32  DWORD strh_scale;\n33  DWORD strh_rate;\n34  DWORD strh_start;\n45  DWORD strh_length;\n36  DWORD strh_sugg_buff_sz;\n37  DWORD strh_quality;\n38  DWORD strh_sample_sz;\n39  DWORD LIST_strf;          // \"strf\"\n40  DWORD strf_size_list;     // 40\n41  DWORD strf_size;          // 40\n42  DWORD strf_width;\n43  DWORD strf_height;\n44  DWORD strf_planes_bit_cnt;\n45  DWORD strf_compression;\n46  DWORD strf_image_size;\n47  DWORD strf_xpels_meter;\n48  DWORD strf_ypels_meter;\n49  DWORD strf_num_colors;\n50  DWORD strf_imp_colors;\n51  DWORD LIST_ODML;          // \"LIST\"\n52  DWORD LIST_ODML_Size;     // 16\n53  DWORD LIST_ODML_type;     // \"odml\"\n54  DWORD odml_fourCC;        // \"dmlh\"\n55  DWORD odml_size;          // 4\n56  DWORD odml_frames;  \n57  DWORD LIST_movi;          // \"LIST\"\n58  DWORD LIST_movi_size;     // SUM( JPEG data size) + (8 * frames) + 4\n59  DWORD LIST_movi_name;     // \"movi\"\n"},{"id":"24998381.eba1fc","type":"function","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"message","func":"msg.payload = \"Unable to capture image\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":860,"wires":[["6c9aa8ce.ff4ef"]]},{"id":"6c9aa8ce.ff4ef","type":"http response","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","statusCode":"500","headers":{},"x":1140,"y":860,"wires":[]},{"id":"7ca7259c.c40d5c","type":"inject","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"Test /capture","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"name\":\"Test\"}","payloadType":"json","x":1950,"y":380,"wires":[["3ce24065.52258"]]},{"id":"3ce24065.52258","type":"http request","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"GET /capture","method":"GET","ret":"obj","paytoqs":"query","url":"localhost:1880/timelapse/capture","tls":"","persist":false,"proxy":"","authType":"basic","x":2170,"y":380,"wires":[["7132482f.f197d"]]},{"id":"7132482f.f197d","type":"debug","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2450,"y":380,"wires":[]},{"id":"b963606f.aeb918","type":"http response","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","statusCode":"","headers":{},"x":1490,"y":800,"wires":[]},{"id":"48c971e4.4f695","type":"change","z":"806f967.bc952e8","g":"874fd402.b76fa","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"timelapse","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1320,"y":800,"wires":[["b963606f.aeb918"]]},{"id":"831c5aaa.edff6","type":"function","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"Generate AVI Header","func":"msg.filename = flow.get('storage') + msg.timelapse.filename + '/avi.header';\n\nfunction toLILEND( value, buf, dword) {\n    pos = dword * 4;\n    buf[pos + 0] = (value & 0xff);\n    buf[pos + 1] = ( (value >> 8 ) & 0xff);\n    buf[pos + 2] = ( (value >> 16 ) & 0xff);\n    buf[pos + 3] = ( (value >> 24 ) & 0xff);\n}\n\nfunction toFOURCC(text, buf, dword) {\n    pos = dword * 4;\n    buf[pos + 0] = text.charCodeAt(0);\n    buf[pos + 1] = text.charCodeAt(1);\n    buf[pos + 2] = text.charCodeAt(2);\n    buf[pos + 3] = text.charCodeAt(3);\n}\n\naviHeader = Buffer.alloc(240);\n\ntoFOURCC(\"RIFF\",aviHeader,0); //LIST_RIFF\ntoLILEND(240,aviHeader,1); //RIFF_size\ntoFOURCC(\"AVI \",aviHeader,2); //RIFF_toFOURCC\ntoFOURCC(\"LIST\",aviHeader,3); //LIST_HDRL\ntoLILEND(208,aviHeader,4); //hdrl_size\ntoFOURCC(\"hdrl\",aviHeader,5); //hdrl_name\ntoFOURCC(\"avih\",aviHeader,6); //avih\ntoLILEND(56,aviHeader,7); //avih_size\ntoLILEND(parseInt(1000000/msg.payload.fps),aviHeader,8); //AVIH_MicroSecPerFrame\ntoLILEND(6400,aviHeader,9); //AVIH_MaxBytesPerSec\ntoLILEND(0,aviHeader,10); //AVIH_PaddingGranularity\ntoLILEND(0x10,aviHeader,11); //AVIH_Flags = Has Index\ntoLILEND(0,aviHeader,12); //AVIH_TotalFrames = 0\ntoLILEND(0,aviHeader,13); //AVIH_InitialFrames = 0\ntoLILEND(1,aviHeader,14); //AVIH_Streams = 1\ntoLILEND(0,aviHeader,15); //AVIH_SugestedBufferSize = 1\ntoLILEND(msg.payload.width,aviHeader,16); //AVIH_Width\ntoLILEND(msg.payload.height,aviHeader,17); //AVIH_Height\ntoLILEND(0,aviHeader,18); //AVIH_Reserved1\ntoLILEND(0,aviHeader,19); //AVIH_Reserved2\ntoLILEND(0,aviHeader,20); //AVIH_Reserved3\ntoLILEND(0,aviHeader,21); //AVIH_Reserved4\ntoFOURCC(\"LIST\",aviHeader,22); //LIST_strl\ntoLILEND(132,aviHeader,23); //LIST_strl_size\ntoFOURCC(\"strl\",aviHeader,24); //LIST_strl_name\ntoFOURCC(\"strh\",aviHeader,25); //STRH_name\ntoLILEND(48,aviHeader,26); //STRH_size\ntoFOURCC(\"vids\",aviHeader,27); //strh_fccType\ntoFOURCC(\"MJPG\",aviHeader,28); //strh_fccHandler\ntoLILEND(0,aviHeader,29); //strh_flags\ntoLILEND(0,aviHeader,30); //strh_priority\ntoLILEND(0,aviHeader,31); //strh_init_frames\ntoLILEND(1,aviHeader,32); //strh_scale\ntoLILEND(msg.payload.fps,aviHeader,33); //strh_scale\ntoLILEND(0,aviHeader,34); //strh_start\ntoLILEND(0,aviHeader,35); //strh_length (Number of frames)\ntoLILEND(64000,aviHeader,36); //strh_sugg_buff_sz (average size per JPEG)\ntoLILEND(0,aviHeader,37); //strh_quality\ntoLILEND(0,aviHeader,38); //strh_sample_sz\ntoFOURCC(\"strf\",aviHeader,39); //LIST_strf\ntoLILEND(40,aviHeader,40); //strf_size_list\ntoLILEND(40,aviHeader,41); //strf_size\ntoLILEND(msg.payload.width,aviHeader,42); //strf_width\ntoLILEND(msg.payload.height,aviHeader,43); //strf_height\ntoLILEND(1 + 24*256*256,aviHeader,44); //strf_planes_bit_cnt\ntoFOURCC(\"MJPG\",aviHeader,45); //strf_compression\ntoLILEND(msg.payload.width * msg.payload.height * 3,aviHeader,46); //strf_image_size\ntoLILEND(0,aviHeader,47); //strf_xpels_meter\ntoLILEND(0,aviHeader,48); //strf_ypels_meter\ntoLILEND(0,aviHeader,49); //strf_num_colors\ntoLILEND(0,aviHeader,50); //strf_imp_colors\ntoFOURCC(\"LIST\",aviHeader,51); //LIST_ODML\ntoLILEND(16,aviHeader,52); //LIST_ODML_Size\ntoFOURCC(\"odml\",aviHeader,53); //LIST_ODML_type\ntoFOURCC(\"dmlh\",aviHeader,54); //odml_toFOURCC\ntoLILEND(4,aviHeader,55); //odml_size\ntoLILEND(0,aviHeader,56); //odml_frames\ntoFOURCC(\"LIST\",aviHeader,57); //LIST_movi\ntoLILEND(4,aviHeader,58); //LIST_movi_size SUM( JPEG data size) + (8 * frames) + 4\ntoFOURCC(\"movi\",aviHeader,59); //LIST_movi_name\n\nmsg.payload = aviHeader;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":240,"wires":[["c3e70bf1.45dcd","587e9b12.06992c"]],"info":"00  DWORD LIST_RIFF;        // \"RIFF\"\n01  DWORD RIFF_size;        // \n02  DWORD RIFF_FOURCC;      // \"avi \"\n03  DWORD LIST_HDRL;         // \"LIST\"\n04  DWORD hdrl_size;         // 208\n05  DWORD hdrl_name;         // \"hdrl\"\n06  DWORD avih;              // \"avih\"\n07 DWORD avih_size;         // 56\n08  DWORD AVIH_MicroSecPerFrame;\n09  DWORD AVIH_MaxBytesPerSec;\n10  DWORD AVIH_PaddingGranularity;\n11  DWORD AVIH_Flags;\n12  DWORD AVIH_TotalFrames;\n13  DWORD AVIH_InitialFrames;\n14  DWORD AVIH_Streams;\n15  DWORD AVIH_SugestedBufferSize;\n16  DWORD AVIH_Width;\n17  DWORD AVIH_Height;\n18  DWORD AVIH_Reserved1;\n19  DWORD AVIH_Reserved2;\n20  DWORD AVIH_Reserved3;\n21  DWORD AVIH_Reserved4;\n22  DWORD LIST_strl;          // \"LIST\"\n23  DWORD LIST_strl_size;     // 132\n24  DWORD LIST_strl_name;     // \"strl\"\n25  DWORD STRH_name;          // \"strh\"\n26  DWORD STRH_size;          // 48\n27  DWORD strh_fccType;\n28  DWORD strh_fccHandler;\n29  DWORD strh_flags;\n30  DWORD strh_priority;\n31  DWORD strh_init_frames;\n32  DWORD strh_scale;\n33  DWORD strh_rate;\n34  DWORD strh_start;\n45  DWORD strh_length;\n36  DWORD strh_sugg_buff_sz;\n37  DWORD strh_quality;\n38  DWORD strh_sample_sz;\n39  DWORD LIST_strf;          // \"strf\"\n40  DWORD strf_size_list;     // 40\n41  DWORD strf_size;          // 40\n42  DWORD strf_width;\n43  DWORD strf_height;\n44  DWORD strf_planes_bit_cnt;\n45  DWORD strf_compression;\n46  DWORD strf_image_size;\n47  DWORD strf_xpels_meter;\n48  DWORD strf_ypels_meter;\n49  DWORD strf_num_colors;\n50  DWORD strf_imp_colors;\n51  DWORD LIST_ODML;          // \"LIST\"\n52  DWORD LIST_ODML_Size;     // 16\n53  DWORD LIST_ODML_type;     // \"odml\"\n54  DWORD odml_fourCC;        // \"dmlh\"\n55  DWORD odml_size;          // 4\n56  DWORD odml_frames;  \n57  DWORD LIST_movi;          // \"LIST\"\n58  DWORD LIST_movi_size;     // SUM( JPEG data size) + (8 * frames) + 4\n59  DWORD LIST_movi_name;     // \"movi\"\n"},{"id":"c3e70bf1.45dcd","type":"file","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":870,"y":240,"wires":[["c7f44295.35241"]]},{"id":"630eb70f.8fc01","type":"http in","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"","url":"/timelapse","method":"post","upload":false,"swaggerDoc":"","x":220,"y":240,"wires":[["1d4e8c50.a8e83c"]]},{"id":"1d4e8c50.a8e83c","type":"function","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"Validate request","func":"timelapse = flow.get(\"timelapse\") || {};\n\nif( !msg.payload.hasOwnProperty(\"name\") ) {\n    msg.payload = {\n        error: \"Missing property name\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nif( msg.payload.name.length < 4 ) {\n    msg.payload = {\n        error: \"Property \" + msg.payload.name + \" is too short\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nif( timelapse.hasOwnProperty(msg.payload.name) ) {\n    msg.payload = {\n        error: 'Timelpase ' + msg.payload.name + \" already exists\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nmsg.payload.filename = msg.payload.name.replace(/\\s/g, \"_\");\n\nif( !msg.payload.hasOwnProperty(\"width\") ) {\n    msg.payload = {\n        error: \"Missing property width\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.payload.width = parseInt(msg.payload.width);\n\nif( !msg.payload.hasOwnProperty(\"height\") ) {\n    msg.payload = {\n        error: \"Missing property height\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.payload.height = parseInt(msg.payload.height);\n\nif( !msg.payload.hasOwnProperty(\"fps\") ) {\n    msg.payload = {\n        error: \"Missing property fps\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.payload.fps = parseInt(msg.payload.fps);\n\nmsg.payload.first = null;\nmsg.payload.last = null;\nmsg.payload.frames = 0;\nmsg.payload.size = 0;\nmsg.payload.downloads = 0;\ntimelapse[msg.payload.name] = msg.payload;\nflow.set(\"timelapse\", timelapse);\nmsg.timelapse = msg.payload;\n\nnode.send([msg,null]);\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":240,"wires":[["831c5aaa.edff6"],["ec42ed35.143768"]],"info":"00  DWORD LIST_RIFF;        // \"RIFF\"\n01  DWORD RIFF_size;        // \n02  DWORD RIFF_FOURCC;      // \"avi \"\n03  DWORD LIST_HDRL;         // \"LIST\"\n04  DWORD hdrl_size;         // 208\n05  DWORD hdrl_name;         // \"hdrl\"\n06  DWORD avih;              // \"avih\"\n07 DWORD avih_size;         // 56\n08  DWORD AVIH_MicroSecPerFrame;\n09  DWORD AVIH_MaxBytesPerSec;\n10  DWORD AVIH_PaddingGranularity;\n11  DWORD AVIH_Flags;\n12  DWORD AVIH_TotalFrames;\n13  DWORD AVIH_InitialFrames;\n14  DWORD AVIH_Streams;\n15  DWORD AVIH_SugestedBufferSize;\n16  DWORD AVIH_Width;\n17  DWORD AVIH_Height;\n18  DWORD AVIH_Reserved1;\n19  DWORD AVIH_Reserved2;\n20  DWORD AVIH_Reserved3;\n21  DWORD AVIH_Reserved4;\n22  DWORD LIST_strl;          // \"LIST\"\n23  DWORD LIST_strl_size;     // 132\n24  DWORD LIST_strl_name;     // \"strl\"\n25  DWORD STRH_name;          // \"strh\"\n26  DWORD STRH_size;          // 48\n27  DWORD strh_fccType;\n28  DWORD strh_fccHandler;\n29  DWORD strh_flags;\n30  DWORD strh_priority;\n31  DWORD strh_init_frames;\n32  DWORD strh_scale;\n33  DWORD strh_rate;\n34  DWORD strh_start;\n45  DWORD strh_length;\n36  DWORD strh_sugg_buff_sz;\n37  DWORD strh_quality;\n38  DWORD strh_sample_sz;\n39  DWORD LIST_strf;          // \"strf\"\n40  DWORD strf_size_list;     // 40\n41  DWORD strf_size;          // 40\n42  DWORD strf_width;\n43  DWORD strf_height;\n44  DWORD strf_planes_bit_cnt;\n45  DWORD strf_compression;\n46  DWORD strf_image_size;\n47  DWORD strf_xpels_meter;\n48  DWORD strf_ypels_meter;\n49  DWORD strf_num_colors;\n50  DWORD strf_imp_colors;\n51  DWORD LIST_ODML;          // \"LIST\"\n52  DWORD LIST_ODML_Size;     // 16\n53  DWORD LIST_ODML_type;     // \"odml\"\n54  DWORD odml_fourCC;        // \"dmlh\"\n55  DWORD odml_size;          // 4\n56  DWORD odml_frames;  \n57  DWORD LIST_movi;          // \"LIST\"\n58  DWORD LIST_movi_size;     // SUM( JPEG data size) + (8 * frames) + 4\n59  DWORD LIST_movi_name;     // \"movi\"\n"},{"id":"ec42ed35.143768","type":"http response","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"","statusCode":"400","headers":{},"x":640,"y":280,"wires":[]},{"id":"ea25973f.c518b8","type":"http response","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"","statusCode":"","headers":{},"x":1250,"y":240,"wires":[]},{"id":"affa29f6.c49e98","type":"change","z":"806f967.bc952e8","g":"6a59659e.dba2a4","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"timelapse","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":120,"wires":[["68457c90.cba174"]]},{"id":"68457c90.cba174","type":"split","z":"806f967.bc952e8","g":"6a59659e.dba2a4","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":610,"y":120,"wires":[["95b8fea6.1992f8"]]},{"id":"95b8fea6.1992f8","type":"join","z":"806f967.bc952e8","g":"6a59659e.dba2a4","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":770,"y":120,"wires":[["b78b0155.d3683"]]},{"id":"b78b0155.d3683","type":"http response","z":"806f967.bc952e8","g":"6a59659e.dba2a4","name":"","statusCode":"","headers":{},"x":920,"y":120,"wires":[]},{"id":"535a2b7f.8b3acc","type":"inject","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"List","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":1930,"y":240,"wires":[["a1a0ba07.85b37"]]},{"id":"a1a0ba07.85b37","type":"http request","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"GET /timelapse","method":"GET","ret":"obj","paytoqs":"ignore","url":"localhost:1880/timelapse","tls":"","persist":false,"proxy":"","authType":"basic","x":2180,"y":240,"wires":[["8ca725b4.8ee908"]]},{"id":"8ca725b4.8ee908","type":"debug","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2430,"y":240,"wires":[]},{"id":"b34a20ab.e80cb8","type":"function","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"Check properties","func":"if( !msg.payload.hasOwnProperty(\"name\") ) {\n    msg.payload = \"Missing name\";\n    msg.statusCode = 400;\n    node.send([null,msg]);\n    return;\n}\n\ntimelapse = flow.get(\"timelapse\");\nif(!timelapse) {\n    msg.payload = {\n        error: \"Timelapse \" + msg.payload.name + \" is not avaialble\"\n    }\n    msg.statusCode = 500;\n    node.send([null,msg]);\n    return;\n}\n\nif( !timelapse.hasOwnProperty(msg.payload.name) ) {\n    msg.payload = {\n        error: \"Timelapse \" + msg.payload.name + \" is not avaialble\"\n    }\n    msg.statusCode = 500;\n    node.send([null,msg]);\n    return;\n}\n\nmsg.timelapse = timelapse[msg.payload.name];\n\nif( msg.payload.hasOwnProperty(\"fps\") )\n    msg.payload.fps = parseInt(msg.payload.fps);\nelse\n    msg.payload.fps = msg.timelapse.fps;\n\nmsg.download = msg.payload;\nmsg.path = flow.get(\"storage\");\n\nreturn msg;","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":600,"wires":[["555a19d4.9f385"],["14f645dd.f3eba2"]]},{"id":"f03c26ff.1a825","type":"function","z":"806f967.bc952e8","g":"a19564b8.e45188","name":"AVI Header Parser","func":"function fromLILEND( buf, dword ) {\n    var pos = dword * 4;\n     return (buf[pos+3] << 24) + (buf[pos+2] << 16) + (buf[pos+1] << 8) + buf[pos];\n}\n\nfunction fromFOURCC( buf, dword) {\n    return buf.toString('utf8', dword*4, (dword*4) + 4);\n}\n\ntheBuffer = msg.payload;\n\ndata = {};\n\ndata.LIST_RIFF = fromFOURCC(theBuffer,0);\ndata.RIFF_size = fromLILEND(theBuffer,1);\ndata.RIFF_FOURCC = fromFOURCC(theBuffer,2);\ndata.LIST_HDRL = fromFOURCC(theBuffer,3);\ndata.hdrl_size = fromLILEND(theBuffer,4);\ndata.hdrl_name = fromFOURCC(theBuffer,5);\ndata.avih = fromFOURCC(theBuffer,6);\ndata.avih_size = fromLILEND(theBuffer,7);\ndata.AVIH_MicroSecPerFrame = fromLILEND(theBuffer,8);\ndata.AVIH_MaxBytesPerSec = fromLILEND(theBuffer,9);\ndata.AVIH_PaddingGranularity = fromLILEND(theBuffer,10);\ndata.AVIH_Flags = fromLILEND(theBuffer,11);\ndata.AVIH_TotalFrames = fromLILEND(theBuffer,12);\ndata.AVIH_InitialFrames = fromLILEND(theBuffer,13);\ndata.AVIH_Streams = fromLILEND(theBuffer,14);\ndata.AVIH_SugestedBufferSize = fromLILEND(theBuffer,15);\ndata.AVIH_Width = fromLILEND(theBuffer,16);\ndata.AVIH_Height = fromLILEND(theBuffer,17);\ndata.AVIH_Reserved1 = fromLILEND(theBuffer,18);\ndata.AVIH_Reserved2 = fromLILEND(theBuffer,19);\ndata.AVIH_Reserved3 = fromLILEND(theBuffer,20);\ndata.AVIH_Reserved4 = fromLILEND(theBuffer,21);\ndata.LIST_strl = fromFOURCC(theBuffer,22);\ndata.LIST_strl_size = fromLILEND(theBuffer,23);\ndata.LIST_strl_name = fromFOURCC(theBuffer,24);\ndata.STRH_name = fromFOURCC(theBuffer,25);\ndata.STRH_size = fromLILEND(theBuffer,26);\ndata.strh_fccType = fromFOURCC(theBuffer,27);\ndata.strh_fccHandler = fromFOURCC(theBuffer,28);\ndata.strh_flags = fromLILEND(theBuffer,29);\ndata.strh_priority = fromLILEND(theBuffer,30);\ndata.strh_init_frames  = fromLILEND(theBuffer,31);\ndata.strh_scale = fromLILEND(theBuffer,32);\ndata.strh_rate = fromLILEND(theBuffer,33);\ndata.strh_start = fromLILEND(theBuffer,34);\ndata.strh_length = fromLILEND(theBuffer,35);\ndata.strh_sugg_buff_sz = fromLILEND(theBuffer,36);\ndata.strh_quality = fromLILEND(theBuffer,37);\ndata.strh_sample_sz = fromLILEND(theBuffer,38);\ndata.LIST_strf = fromFOURCC(theBuffer,39);\ndata.strf_size_list = fromLILEND(theBuffer,40);\ndata.strf_size = fromLILEND(theBuffer,41);\ndata.strf_width = fromLILEND(theBuffer,42);\ndata.strf_height = fromLILEND(theBuffer,43);\ndata.strf_planes_bit_cnt = fromLILEND(theBuffer,44);\ndata.strf_compression = fromFOURCC(theBuffer,45);\ndata.strf_image_size = fromLILEND(theBuffer,46);\ndata.strf_xpels_meter = fromLILEND(theBuffer,47);\ndata.strf_ypels_meter = fromLILEND(theBuffer,48);\ndata.strf_num_colors = fromLILEND(theBuffer,49);\ndata.strf_imp_colors = fromLILEND(theBuffer,50);\ndata.LIST_ODML = fromFOURCC(theBuffer,51);\ndata.LIST_ODML_Size = fromLILEND(theBuffer,52);\ndata.LIST_ODML_type = fromFOURCC(theBuffer,53);\ndata.odml_fourCC = fromFOURCC(theBuffer,54);\ndata.odml_size = fromLILEND(theBuffer,55);\ndata.odml_frames = fromLILEND(theBuffer,56);\ndata.LIST_movi = fromFOURCC(theBuffer,57);\ndata.LIST_movi_size = fromLILEND(theBuffer,58);\ndata.LIST_movi_name = fromFOURCC(theBuffer,59);\n\nmsg.payload = data;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1590,"y":80,"wires":[["22fb67ac.2e5be8"]]},{"id":"22fb67ac.2e5be8","type":"debug","z":"806f967.bc952e8","g":"a19564b8.e45188","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1820,"y":80,"wires":[]},{"id":"9539bbdc.52555","type":"link in","z":"806f967.bc952e8","name":"","links":["84f4a4b8.26d59","5a2dad2d.e5bb14","7590716f.b28e08"],"x":1415,"y":80,"wires":[["f03c26ff.1a825"]]},{"id":"587e9b12.06992c","type":"link out","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"","links":[],"x":835,"y":300,"wires":[]},{"id":"64eb4c38.9c8304","type":"http in","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"","url":"/timelapse","method":"delete","upload":false,"swaggerDoc":"","x":230,"y":420,"wires":[["6c8a1b4f.eebf94"]]},{"id":"6c8a1b4f.eebf94","type":"function","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"Validate request","func":"timelapse = flow.get(\"timelapse\") || {};\n\nif( !msg.payload.hasOwnProperty(\"name\") ) {\n    msg.payload = {\n        error: \"Property name is required\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nif( msg.payload.name.length < 4 ) {\n    msg.payload = {\n        error: \"Property name Name is too short\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nif( !timelapse.hasOwnProperty(msg.payload.name) ) {\n    msg.payload = {\n        error: 'Timelpase ' + msg.payload.name + \" does not exists\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nmsg.timelapse = timelapse[msg.payload.name];\ndelete timelapse[msg.payload.name];\nflow.set(\"timelapse\",timelapse);\n\nmsg.payload = flow.get(\"storage\") + msg.timelapse.filename;\n\nnode.send([msg,null]);\nreturn;\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":420,"wires":[["69279898.bde68"],["4f121ab8.254cf4"]],"info":"00  DWORD LIST_RIFF;        // \"RIFF\"\n01  DWORD RIFF_size;        // \n02  DWORD RIFF_FOURCC;      // \"avi \"\n03  DWORD LIST_HDRL;         // \"LIST\"\n04  DWORD hdrl_size;         // 208\n05  DWORD hdrl_name;         // \"hdrl\"\n06  DWORD avih;              // \"avih\"\n07 DWORD avih_size;         // 56\n08  DWORD AVIH_MicroSecPerFrame;\n09  DWORD AVIH_MaxBytesPerSec;\n10  DWORD AVIH_PaddingGranularity;\n11  DWORD AVIH_Flags;\n12  DWORD AVIH_TotalFrames;\n13  DWORD AVIH_InitialFrames;\n14  DWORD AVIH_Streams;\n15  DWORD AVIH_SugestedBufferSize;\n16  DWORD AVIH_Width;\n17  DWORD AVIH_Height;\n18  DWORD AVIH_Reserved1;\n19  DWORD AVIH_Reserved2;\n20  DWORD AVIH_Reserved3;\n21  DWORD AVIH_Reserved4;\n22  DWORD LIST_strl;          // \"LIST\"\n23  DWORD LIST_strl_size;     // 132\n24  DWORD LIST_strl_name;     // \"strl\"\n25  DWORD STRH_name;          // \"strh\"\n26  DWORD STRH_size;          // 48\n27  DWORD strh_fccType;\n28  DWORD strh_fccHandler;\n29  DWORD strh_flags;\n30  DWORD strh_priority;\n31  DWORD strh_init_frames;\n32  DWORD strh_scale;\n33  DWORD strh_rate;\n34  DWORD strh_start;\n45  DWORD strh_length;\n36  DWORD strh_sugg_buff_sz;\n37  DWORD strh_quality;\n38  DWORD strh_sample_sz;\n39  DWORD LIST_strf;          // \"strf\"\n40  DWORD strf_size_list;     // 40\n41  DWORD strf_size;          // 40\n42  DWORD strf_width;\n43  DWORD strf_height;\n44  DWORD strf_planes_bit_cnt;\n45  DWORD strf_compression;\n46  DWORD strf_image_size;\n47  DWORD strf_xpels_meter;\n48  DWORD strf_ypels_meter;\n49  DWORD strf_num_colors;\n50  DWORD strf_imp_colors;\n51  DWORD LIST_ODML;          // \"LIST\"\n52  DWORD LIST_ODML_Size;     // 16\n53  DWORD LIST_ODML_type;     // \"odml\"\n54  DWORD odml_fourCC;        // \"dmlh\"\n55  DWORD odml_size;          // 4\n56  DWORD odml_frames;  \n57  DWORD LIST_movi;          // \"LIST\"\n58  DWORD LIST_movi_size;     // SUM( JPEG data size) + (8 * frames) + 4\n59  DWORD LIST_movi_name;     // \"movi\"\n"},{"id":"69279898.bde68","type":"exec","z":"806f967.bc952e8","g":"8ea22993.f0a7b","command":"rm -R ","addpay":"payload","append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":670,"y":420,"wires":[[],[],["15e6cd00.29090b"]]},{"id":"4f121ab8.254cf4","type":"http response","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"","statusCode":"400","headers":{},"x":680,"y":480,"wires":[]},{"id":"67745d8d.2cf4a4","type":"change","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"timelapse","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":420,"wires":[["f3501c9c.af39"]]},{"id":"f3501c9c.af39","type":"http response","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"","statusCode":"","headers":{},"x":1190,"y":420,"wires":[]},{"id":"78d97784.494ea","type":"inject","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"Delete Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"name\":\"Test\"}","payloadType":"json","x":1940,"y":320,"wires":[["9e44dcc7.a90128"]]},{"id":"9e44dcc7.a90128","type":"http request","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"DELETE /timelapse","method":"DELETE","ret":"obj","paytoqs":"ignore","url":"localhost:1880/timelapse","tls":"","persist":false,"proxy":"","authType":"basic","x":2190,"y":320,"wires":[["e1c07ef1.7d71f"]]},{"id":"e1c07ef1.7d71f","type":"debug","z":"806f967.bc952e8","g":"bb3e510e.943d1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2430,"y":320,"wires":[]},{"id":"40afe6bc.baf638","type":"function","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"Message","func":"msg.statusCode = 500;\nmsg.payload = {\n    error:\"Unable to remove files for \" + msg.timelapse.name\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":460,"wires":[["f3501c9c.af39"]]},{"id":"15e6cd00.29090b","type":"switch","z":"806f967.bc952e8","g":"8ea22993.f0a7b","name":"","property":"payload.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":420,"wires":[["67745d8d.2cf4a4"],["40afe6bc.baf638"]]},{"id":"c7f44295.35241","type":"change","z":"806f967.bc952e8","g":"e4467bc4.acab98","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"timelapse","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":240,"wires":[["ea25973f.c518b8"]]},{"id":"555a19d4.9f385","type":"subflow:9c439745.ecd388","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"","env":[],"x":710,"y":600,"wires":[["5a339d1c.be877c"]]},{"id":"d44334f2.b4e63","type":"http in","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"","url":"/timelapse/export","method":"get","upload":false,"swaggerDoc":"","x":240,"y":600,"wires":[["b34a20ab.e80cb8"]]},{"id":"14f645dd.f3eba2","type":"http response","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"","statusCode":"","headers":{},"x":680,"y":640,"wires":[]},{"id":"5a339d1c.be877c","type":"file in","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":890,"y":600,"wires":[["bb50ffab.f211a"]]},{"id":"bb50ffab.f211a","type":"function","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"Set headers","func":"d = new Date();\n\nseconds = (msg.timelapse.last - msg.timelapse.first) / 1000;\nduration = parseInt(seconds) + \"_s\";\nif( seconds > 60 )\n    duration = parseInt(seconds/60) + \"m\";\nif( seconds > 3600 )\n    duration = parseInt(seconds/3600) + \"h\";\nif( seconds > (3600*24) )\n    duration = parseInt(seconds/(3600*24)) + \"d\";\n\nfilename = msg.timelapse.filename + \"_\"\nfilename += d.getFullYear() + \"-\" + (\"00\"+(d.getMonth()+1)).substr(-2,2) + \"-\" + (\"00\"+d.getDate()).substr(-2,2) + \"_\";\nfilename += duration + \"_\";\nfilename += msg.download.fps + \"fps\";\nfilename += \".avi\";\n\nmsg.headers = {}\nmsg.headers['Content-Description'] = 'File Transfer';\nmsg.headers['Content-Transfer-Encoding'] = 'binary';\nmsg.headers[\"Content-Type\"] = \"video/x-msvideo\",\nmsg.headers[\"Content-Disposition\"] = \"attachment; filename=\" + filename;\nmsg.headers[\"Content-Length\"] = msg.payload.length;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":600,"wires":[["f056eabe.8c4e38"]]},{"id":"f056eabe.8c4e38","type":"http response","z":"806f967.bc952e8","g":"80a9e208.50ded8","name":"","statusCode":"","headers":{},"x":1220,"y":600,"wires":[]},{"id":"db91f259.4d692","type":"axis-camera","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","preset":"afc3f646.d65d88","action":"JPEG Image","resolution":"320x180","output":"Buffer","filename":"","options":"","x":670,"y":980,"wires":[["83ee01eb.a17318"]]},{"id":"15f226ff.ba5691","type":"file","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":1130,"y":980,"wires":[["8543fb83.e062d"]]},{"id":"8543fb83.e062d","type":"function","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"Indexfile","func":"msg.filename = flow.get(\"storage\") + msg.timelapse.filename + '/avi.index';\n\nd = new Date();\n\nmsg.timelapse.frames++;\nmsg.timelapse.size += msg.payload.length;\nif( msg.timelapse.first === null )\n    msg.timelapse.first = d.getTime();\nmsg.timelapse.last = d.getTime();\n\nmsg.payload = msg.size;\n\ntimelapse = flow.get(\"timelapse\") || {};\ntimelapse[msg.timelapse.name] = msg.timelapse;\nflow.set(\"timelapse\",timelapse);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":1020,"wires":[["f1323354.b2dd88"]]},{"id":"f1323354.b2dd88","type":"file","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":1130,"y":1020,"wires":[["207ae537.fba842"]]},{"id":"2e3a19a1.09c306","type":"function","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"Datafile","func":"msg.filename = flow.get(\"storage\") + msg.timelapse.filename + '/avi.data';\n\njpeg = msg.payload;\navi1String = \"AVI1\";\njpeg[6] = avi1String.charCodeAt(0);\njpeg[7] = avi1String.charCodeAt(1);\njpeg[8] = avi1String.charCodeAt(2);\njpeg[9] = avi1String.charCodeAt(3);\n\nsize = jpeg.length;\npadding = (4-(size%4)) % 4;\nsize += padding;\nentry = Buffer.alloc(8);\n//entry = '00db' + JPEG_Size\n\nvar entryString = \"00db\";\nentry[0] = entryString.charCodeAt(0);\nentry[1] = entryString.charCodeAt(1);\nentry[2] = entryString.charCodeAt(2);\nentry[3] = entryString.charCodeAt(3);\nentry[4] = size & 0xff;\nentry[5] = (size >> 8) & 0xff;\nentry[6] = (size >> 16) & 0xff;\nentry[7] = (size >> 24) & 0xff;\npaddingBuffer = Buffer.alloc(padding);\n\ntotalLength = entry.length + jpeg.length + paddingBuffer.length;\nmsg.payload = Buffer.concat([entry,jpeg,paddingBuffer], totalLength);\n\nmsg.size = size;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":980,"wires":[["15f226ff.ba5691"]]},{"id":"83ee01eb.a17318","type":"switch","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"OK?","property":"error","propertyType":"msg","rules":[{"t":"eq","v":"false","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":980,"wires":[["2e3a19a1.09c306"],["9364d2f5.d053f8"]]},{"id":"88872a61.454258","type":"http in","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","url":"/timelapse/capture","method":"post","upload":false,"swaggerDoc":"","x":250,"y":980,"wires":[["fe11c45d.a72058"]]},{"id":"fe11c45d.a72058","type":"function","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"Validate request","func":"if( !msg.payload.hasOwnProperty(\"name\") ) {\n    msg.payload = {\n        error: \"Missing name\"\n    }\n    node.send([null,msg]);\n    return;\n}\n\nif( !msg.payload.hasOwnProperty(\"address\") ) {\n    msg.payload = {\n        error: \"Missing address\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.address = msg.payload.address;\n\nif( !msg.payload.hasOwnProperty(\"user\") ) {\n    msg.payload = {\n        error: \"Missing user\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.user = msg.payload.user;\n\nif( !msg.payload.hasOwnProperty(\"password\") ) {\n    msg.payload = {\n        error: \"Missing password\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.password = msg.payload.password;\n\n\ntimelapse = flow.get(\"timelapse\") || {};\nif( !timelapse.hasOwnProperty(msg.payload.name) ) {\n    msg.payload = {\n        error: \"Timelapse \" + msg.payload.name + \" is invalid\"\n    }\n    node.send([null,msg]);\n    return;\n}\nmsg.payload = timelapse[msg.payload.name];\n\nmsg.timelapse = msg.payload;\nmsg.resolution = msg.payload.width + \"x\" + msg.payload.height;\nnode.send([msg,null]);","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":980,"wires":[["db91f259.4d692"],["45972405.864dcc"]],"info":"00  DWORD LIST_RIFF;        // \"RIFF\"\n01  DWORD RIFF_size;        // \n02  DWORD RIFF_FOURCC;      // \"avi \"\n03  DWORD LIST_HDRL;         // \"LIST\"\n04  DWORD hdrl_size;         // 208\n05  DWORD hdrl_name;         // \"hdrl\"\n06  DWORD avih;              // \"avih\"\n07 DWORD avih_size;         // 56\n08  DWORD AVIH_MicroSecPerFrame;\n09  DWORD AVIH_MaxBytesPerSec;\n10  DWORD AVIH_PaddingGranularity;\n11  DWORD AVIH_Flags;\n12  DWORD AVIH_TotalFrames;\n13  DWORD AVIH_InitialFrames;\n14  DWORD AVIH_Streams;\n15  DWORD AVIH_SugestedBufferSize;\n16  DWORD AVIH_Width;\n17  DWORD AVIH_Height;\n18  DWORD AVIH_Reserved1;\n19  DWORD AVIH_Reserved2;\n20  DWORD AVIH_Reserved3;\n21  DWORD AVIH_Reserved4;\n22  DWORD LIST_strl;          // \"LIST\"\n23  DWORD LIST_strl_size;     // 132\n24  DWORD LIST_strl_name;     // \"strl\"\n25  DWORD STRH_name;          // \"strh\"\n26  DWORD STRH_size;          // 48\n27  DWORD strh_fccType;\n28  DWORD strh_fccHandler;\n29  DWORD strh_flags;\n30  DWORD strh_priority;\n31  DWORD strh_init_frames;\n32  DWORD strh_scale;\n33  DWORD strh_rate;\n34  DWORD strh_start;\n45  DWORD strh_length;\n36  DWORD strh_sugg_buff_sz;\n37  DWORD strh_quality;\n38  DWORD strh_sample_sz;\n39  DWORD LIST_strf;          // \"strf\"\n40  DWORD strf_size_list;     // 40\n41  DWORD strf_size;          // 40\n42  DWORD strf_width;\n43  DWORD strf_height;\n44  DWORD strf_planes_bit_cnt;\n45  DWORD strf_compression;\n46  DWORD strf_image_size;\n47  DWORD strf_xpels_meter;\n48  DWORD strf_ypels_meter;\n49  DWORD strf_num_colors;\n50  DWORD strf_imp_colors;\n51  DWORD LIST_ODML;          // \"LIST\"\n52  DWORD LIST_ODML_Size;     // 16\n53  DWORD LIST_ODML_type;     // \"odml\"\n54  DWORD odml_fourCC;        // \"dmlh\"\n55  DWORD odml_size;          // 4\n56  DWORD odml_frames;  \n57  DWORD LIST_movi;          // \"LIST\"\n58  DWORD LIST_movi_size;     // SUM( JPEG data size) + (8 * frames) + 4\n59  DWORD LIST_movi_name;     // \"movi\"\n"},{"id":"45972405.864dcc","type":"http response","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","statusCode":"400","headers":{},"x":660,"y":1040,"wires":[]},{"id":"9364d2f5.d053f8","type":"function","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"message","func":"msg.payload = \"Unable to capture image\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":1080,"wires":[["4f7fbaa7.0e6644"]]},{"id":"4f7fbaa7.0e6644","type":"http response","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","statusCode":"500","headers":{},"x":1140,"y":1080,"wires":[]},{"id":"4300f927.0f1d48","type":"http response","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","statusCode":"","headers":{},"x":1490,"y":1020,"wires":[]},{"id":"207ae537.fba842","type":"change","z":"806f967.bc952e8","g":"ab8145ac.86fb5","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"timelapse","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1320,"y":1020,"wires":[["4300f927.0f1d48"]]},{"id":"9ffd68a3.cf5118","type":"axis-preset","name":"","address":"localhost","protocol":"http"},{"id":"afc3f646.d65d88","type":"axis-preset","name":"msg.address","address":"","protocol":"http"}]
